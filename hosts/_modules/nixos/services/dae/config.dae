global {
    tproxy_port: 7890
    tproxy_port_protect: true
    so_mark_from_dae: 0
    log_level: trace
    wan_interface: auto
    auto_config_kernel_parameter: true
    # tcp_check_url: 'http://cp.cloudflare.com,1.1.1.1,2606:4700:4700::1111'
    # udp_check_dns: 'dns.google.com:53,8.8.8.8,2001:4860:4860::8888'
    check_interval: 30s
    check_tolerance: 50ms
    dial_mode: domain
    sniffing_timeout: 100ms
    tls_implementation: utls
    utls_imitate: chrome_auto
}

subscription {
    default: 'file://default.sub'
}

# ! mosdns is not needed for dae

dns {
    ipversion_prefer: 4
    upstream {
        googledns: 'tcp+udp://dns.google:53'
        alidns: 'udp://dns.alidns.com:53'
        internal: 'udp://127.0.0.1:53'
    }
    routing {
        request {
            qname(suffix:homelab.internal) -> internal
            qname(suffix:noirprime.com) -> internal
            qname(geosite:cn) -> alidns
            fallback: googledns
        }
        response {
            upstream(internal) -> accept
            upstream(googledns) -> accept
            !qname(geosite:cn) && ip(geoip:private) -> googledns
            fallback: accept
        }
    }
}

group {
    proxy {
        filter: name(keyword: 'Hong Kong')
        filter: name(keyword: 'Japan')
        filter: name(keyword: 'Singapore')
        filter: name(keyword: 'Taiwan')
        filter: name(keyword: 'USA')
        policy: min_moving_avg
    }
}

routing {
    pname(AdGuardHome) -> direct(must)
    pname(caddy) -> direct(must)
    pname(easytier-core) -> direct(must)
    pname(lego) -> direct(must)
    dip(geoip:private) -> direct(must)
    domain(geosite:private) -> direct(must)

    pname(NetworkManager) -> direct
    dip(224.0.0.0/3, 'ff00::/8') -> direct
    dscp(0x4) -> direct

    # l4proto(udp) && dport(443) -> block

    dip(geoip:cn) -> direct
    domain(geosite:cn) -> direct
    domain(geosite:geolocation-cn) -> direct

    fallback: proxy
}
