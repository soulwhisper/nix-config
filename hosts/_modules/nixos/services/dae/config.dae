global {
    wan_interface: auto
    # lan_interface: enp6s19 # remove comment if use as tproxy
    log_level: info
    dial_mode: domain
    auto_config_kernel_parameter: true
}

subscription {
    subscription_1: 'file://subscription_1.sub'
    # subscription_2: 'file://subscription_2.sub'
    # subscription_3: 'file://subscription_3.sub'
}

dns {

    ipversion_prefer: 4

    upstream {
        alidns: 'udp://dns.alidns.com:53'
        cfdns: 'https://cloudflare-dns.com/dns-query'
        internal: 'udp://127.0.0.1:53'
    }
    routing {
        request {
            qname(geosite:google@cn) -> alidns
            qname(geosite:cn) -> alidns
            qname(suffix:homelab.internal) -> internal
            qname(suffix:noirprime.com) -> internal
            fallback: cfdns
        }
        response {
            upstream(internal) -> accept
            upstream(cfdns) -> accept
            !qname(geosite:cn) && ip(geoip:private) -> cfdns
            fallback: accept
        }
    }
}

group {
    proxy {
        filter: name(keyword: 'Hong Kong')
        filter: name(keyword: 'Singapore')
        filter: name(keyword: 'USA')
        policy: min
    }
}

routing {
    pname(adguardhome) && l4proto(udp) && dport(53) -> must_direct
    pname(lego) -> must_direct
    pname(caddy) -> must_direct
    pname(easytier-core) -> must_direct

    pname(NetworkManager) -> direct
    dip(224.0.0.0/3, 'ff00::/8') -> direct
    dip(geoip:private) -> direct

    dip(geoip:cn) -> direct
    domain(geosite:cn) -> direct
    domain(geosite:category-scholar-cn) -> direct
    domain(geosite:geolocation-cn) -> direct
    domain(geosite:private) -> direct

    domain(suffix:icloud.com) -> direct
    domain(suffix:icloud-content.com) -> direct
    domain(suffix:cdn-apple.com) -> direct

    fallback: proxy
}
